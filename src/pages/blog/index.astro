---
import Layout from "../../layouts/Layout.astro";
import BlogFeed from "../../components/BlogFeed.astro";
import { client } from "../../lib/sanity";
import type { BlogPost } from "../../types/sanity";

// Get current page from URL params
const url = new URL(Astro.request.url);
const currentPage = parseInt(url.searchParams.get("page") || "1");
const postsPerPage = 4; // Show 4 blog posts per page

// Calculate offset for pagination
const offset = (currentPage - 1) * postsPerPage;

// Fetch blog posts with pagination
const blogPosts = await client.fetch<BlogPost[]>(`
  *[_type == "blogPost" && defined(slug.current)] | order(publishedAt desc) {
    _id,
    title,
    slug,
    excerpt,
    publishedAt,
    cardVariant,
    featuredImage {
      asset->{
        _id,
        url
      },
      alt,
      caption
    },
    "author": author->{
      _id,
      name,
      slug,
      image {
        asset->{
          _id,
          url
        }
      }
    },
    categories[]->{
      _id,
      title,
      slug
    }
  } [${offset}...${offset + postsPerPage}]
`);

// Get total count for pagination
const totalPosts = await client.fetch<number>(`
  count(*[_type == "blogPost" && defined(slug.current)])
`);

const totalPages = Math.ceil(totalPosts / postsPerPage);
---

<Layout>
  <div class="blog__feed--wrapper">
    <BlogFeed
      blogPosts={blogPosts}
      currentPage={currentPage}
      postsPerPage={postsPerPage}
    />
  </div>
</Layout>

<style>
  .blog__feed--wrapper {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
    flex-direction: column;
    justify-self: center;
  }
</style>
