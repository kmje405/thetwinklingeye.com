---
import Layout from "../../layouts/Layout.astro";
import { client, queries, urlFor } from "../../lib/sanity";
import type { BlogPost } from "../../types/sanity";
import { toHTML } from "@portabletext/to-html";
import { Image } from "astro:assets";

export async function getStaticPaths() {
  try {
    const posts = await client.fetch<BlogPost[]>(queries.allBlogPosts);

    return posts.map((post) => ({
      params: { slug: post.slug.current },
    }));
  } catch (error) {
    console.error("Error fetching blog posts for static paths:", error);
    return [];
  }
}

interface Props {
  post: BlogPost;
}

const { slug } = Astro.params;

// Fetch the full blog post with body content
const post = await client.fetch<BlogPost>(queries.blogPost, { slug });

if (!post) {
  return Astro.redirect("/404");
}

// Format date
const formattedDate = new Date(post.publishedAt).toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

// Get featured image URL and dimensions if available
const imageUrl = post.featuredImage
  ? urlFor(post.featuredImage).width(800).url()
  : null;

const imageWidth = post.featuredImage?.asset?.metadata?.dimensions?.width || 800;
const imageHeight = post.featuredImage?.asset?.metadata?.dimensions?.height || 435;

// Calculate aspect ratio to maintain proportions while fitting in container
const aspectRatio = imageWidth / imageHeight;
const containerWidth = 800; // Max width for the container
const calculatedHeight = Math.round(containerWidth / aspectRatio);

// Render portable text to HTML
const bodyHtml = post.body
  ? toHTML(post.body, {
      components: {
        types: {
          image: ({ value }) => {
            // Check if image value exists and has required properties
            if (!value || !value._ref) {
              return `<div class="missing-image">Image not available</div>`;
            }
            try {
              const imageUrl = urlFor(value).width(800).url();
              return `<img src="${imageUrl}" alt="${value.alt || ""}" loading="lazy" style="width: 100%; height: auto;" />`;
            } catch (error) {
              console.warn('Error processing image:', error);
              return `<div class="missing-image">Image not available</div>`;
            }
          },
        },
        marks: {
          link: ({ children, value }) => {
            return `<a href="${value.href}" target="_blank" rel="noopener noreferrer">${children}</a>`;
          },
        },
      },
    })
  : "";
---

<Layout>
  <main class="post">
    <!-- Title spans full width -->
    <header class="post__title">
      <h1>{post.title}</h1>
    </header>

    <!-- Hero / Lead Image -->
    {
      imageUrl && (
        <figure class="post__hero">
          <Image
            src={imageUrl}
            alt={post.featuredImage?.alt || post.title}
            width={containerWidth}
            height={calculatedHeight}
            loading="eager"
            format="webp"
          />
          {post.featuredImage?.caption && (
            <figcaption>{post.featuredImage.caption}</figcaption>
          )}
          
          <!-- Byline beneath photo and caption -->
          <div class="post__byline">
            <p>By {post.author?.name || 'Unknown Author'}</p>
            <p>{formattedDate}</p>
          </div>
        </figure>
      )
    }

    <!-- Right column: Excerpt as pullquote, then byline with tags -->
    <section class="post__intro">
      <!-- Pull Quote / Aside - using excerpt as callout -->
      {
        post.excerpt && (
          <aside class="post__pullquote">
            <blockquote>"{post.excerpt}"</blockquote>
          </aside>
        )
      }

      <!-- Tags only -->
      {
        post.categories && post.categories.length > 0 && (
          <div class="post__categories">
            {post.categories.map((category, index) => (
              <span class="post__category">
                {category.title}
                {index < (post.categories?.length || 0) - 1 ? ", " : ""}
              </span>
            ))}
          </div>
        )
      }
    </section>

    <!-- Main Body spans both columns -->
    <section class="post__body">
      <Fragment set:html={bodyHtml} />
    </section>

    <!-- Comments Section -->
    <section class="post__comments">
      <h3>Comments</h3>
      <hyvor-talk-comments
        website-id="14933"
        page-id={post.slug.current}
      ></hyvor-talk-comments>
    </section>
  </main>


  <style>
    /* Editorial grid layout */
    .post {
      background-color: #f8f0e5;
      max-width: 48rem;

      display: grid;
      grid-template-columns: 1fr 1fr;
      column-gap: 1.5rem;
      row-gap: 0;
      margin: 0 auto;
      padding: 1rem;
      margin-bottom: 2rem;
    }

    /* Title spans full width */
    .post__title {
      grid-column: 1 / -1;
    }

    .post__title h1 {
      font-family: var(--font-header-primary);
      font-size: var(--font-size-h1);
      font-weight: var(--font-weight-h1);
      line-height: var(--line-height-h1);
      color: #333;
      text-align: center;
    }

    /* Hero image in left column */
    .post__hero {
      grid-column: 1 / 2;
      margin: 0;
    }

    .post__hero img,
    .post__hero :global(img) {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 6px;
    }

    .post__hero figcaption {
      font-family: var(--font-body);
      font-size: var(--font-size-body);
      font-weight: var(--font-weight-body);
      line-height: var(--line-height-body);
      color: #333;
      margin-top: 0.5rem;
    }

    .post__byline {
      font-family: var(--font-body);
      font-size: 0.9rem;
      color: #666;
      margin-top: 1rem;
    }

    .post__byline p {
      margin: 0.25rem 0;
    }

    /* Intro in right column */
    .post__intro {
      grid-column: 2 / 3;
      align-self: start;
    }

    /* Body spans both columns */
    .post__body {
      grid-column: 1 / -1;
    }

    /* Pull Quote - now nested in intro, no grid positioning needed */
    .post__pullquote {
      align-self: start;
    }

    .post__pullquote blockquote {
      font-family: var(--font-callout);
      font-size: var(--font-size-callout);
      font-weight: var(--font-weight-callout);
      line-height: 1.1;
      color: #461121;
    }

    .post__categories {
      font-family: var(--font-body);
      font-size: 0.9rem;
      margin-top: 1rem;
    }

    .post__category {
      color: #a37351;
      font-weight: 500;
    }

    .post__body :global(p) {
      font-family: var(--font-body);
      font-size: var(--font-size-body);
      font-weight: var(--font-weight-body);
      line-height: var(--line-height-body);
      color: #333;
      margin-bottom: 1rem;
    }

    .post__body :global(p:last-child) {
      margin-bottom: 0;
    }

    .post__body :global(h1),
    .post__body :global(h2),
    .post__body :global(h3) {
      font-family: var(--font-header-primary);
      color: #333;
      margin: 1.5rem 0 1rem 0;
    }

    .post__body :global(h1) {
      font-size: var(--font-size-h1);
      font-weight: var(--font-weight-h1);
    }

    .post__body :global(h2) {
      font-size: var(--font-size-h2);
      font-weight: var(--font-weight-h2);
    }

    .post__body :global(h3) {
      font-size: var(--font-size-h3);
      font-weight: var(--font-weight-h3);
    }

    /* Pull Quote styling to match post1.astro */
    .post__body :global(blockquote) {
      font-family: var(--font-callout);
      font-size: var(--font-size-callout);
      font-weight: var(--font-weight-callout);
      line-height: 1.1;
      color: #461121;
      margin: 1.5rem 0;
    }

    /* Missing image placeholder styling */
    .post__body :global(.missing-image) {
      background-color: #f5f5f5;
      border: 2px dashed #ccc;
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      color: #666;
      font-style: italic;
      margin: 1.5rem 0;
      font-family: var(--font-body);
    }

    /* Comments Section */
    .post__comments {
      grid-column: 1 / -1;
      margin-top: 3rem;
      padding-top: 2rem;
      border-top: 1px solid #ddd;
    }

    .post__comments h3 {
      font-family: var(--font-header-primary);
      font-size: var(--font-size-h3);
      font-weight: var(--font-weight-h3);
      color: #333;
      margin-bottom: 1.5rem;
      text-align: center;
    }

    /* Mobile collapse */
    @media (max-width: 768px) {
      .post {
        grid-template-columns: 1fr;
        max-width: 100%;
        margin: 2rem;
      }

      /* Stack content in proper order: title, hero (image + caption), intro, body */
      .post__title {
        grid-column: 1;
        order: 1;
      }

      .post__hero {
        grid-column: 1;
        order: 2;
      }

      .post__hero img,
      .post__hero :global(img) {
        border-radius: 0;
      }

      .post__intro {
        grid-column: 1;
        order: 3;
      }

      .post__body {
        grid-column: 1;
        order: 4;
      }

      .post__pullquote blockquote {
        text-align: center;
      }

      .post__pullquote blockquote {
        text-align: center;
      }

      .post__body :global(blockquote) {
        text-align: center;
      }
    }

    /* Tablet adjustments */
    @media (min-width: 769px) and (max-width: 1024px) {
      .post {
        grid-template-columns: 1fr;
        max-width: 100%;
        margin: 2rem;
      }

      /* Stack content in proper order for tablet: title, hero (image + caption), intro, body */
      .post__title {
        grid-column: 1;
        order: 1;
      }

      .post__hero {
        grid-column: 1;
        order: 2;
      }

      .post__hero img,
      .post__hero :global(img) {
        border-radius: 0;
      }

      .post__intro {
        grid-column: 1;
        order: 3;
      }

      .post__body {
        grid-column: 1;
        order: 4;
      }

      .post__body :global(blockquote) {
        text-align: center;
      }
    }
  </style>
</Layout>
