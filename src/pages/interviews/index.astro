---
import Layout from "../../layouts/Layout.astro";
import InterviewFeed from "../../components/InterviewFeed.astro";
import { client, queries } from "../../lib/sanity";
import type { InterviewPreview } from "../../types/sanity";

// Get current page from URL params
const url = new URL(Astro.request.url);
const currentPage = parseInt(url.searchParams.get("page") || "1");
const postsPerPage = 4; // Show 4 interviews per page

// Calculate offset for pagination
const offset = (currentPage - 1) * postsPerPage;

// Fetch interviews from Sanity with fallback
let interviews: InterviewPreview[] = [];
let error: string | null = null;
let totalInterviews = 0;

try {
  if (import.meta.env.PUBLIC_SANITY_PROJECT_ID) {
    // Fetch interviews with pagination
    interviews = await client.fetch<InterviewPreview[]>(`
      *[_type == "interview"] | order(publishedAt desc)[${offset}...${offset + postsPerPage}]{
        _id,
        title,
        slug,
        excerpt,
        publishedAt,
        youtubeUrl,
        thumbnail {
          asset->{
            _id,
            url
          },
          alt,
          caption
        },
        guest->{
          name,
          bio,
          image {
            asset->{
              _id,
              url
            },
            alt,
            caption
          }
        }
      }
    `);

    // Get total count for pagination
    totalInterviews = await client.fetch<number>(`
      count(*[_type == "interview"])
    `);

    // If no interviews found in Sanity, use fallback for testing
    if (totalInterviews === 0) {
      console.warn(
        "No interviews found in Sanity, using fallback data for testing"
      );

      // Create fallback data
      const fallbackInterviews: InterviewPreview[] = [
        {
          _id: "fallback-1",
          title: "Sample Interview 1",
          slug: { _type: "slug", current: "sample-interview-1" },
          excerpt:
            "This is the first sample interview. Connect Sanity to see your actual content.",
          publishedAt: new Date().toISOString(),
          cardVariant: "full-image",
          youtubeUrl: "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
          thumbnail: undefined,
          guest: {
            name: "Guest One",
            bio: undefined,
            image: undefined,
          },
        },
        {
          _id: "fallback-2",
          title: "Sample Interview 2",
          slug: { _type: "slug", current: "sample-interview-2" },
          excerpt:
            "This is the second sample interview for testing pagination.",
          publishedAt: new Date(Date.now() - 86400000).toISOString(),
          cardVariant: "full-image",
          youtubeUrl: "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
          thumbnail: undefined,
          guest: {
            name: "Guest Two",
            bio: undefined,
            image: undefined,
          },
        },
        {
          _id: "fallback-3",
          title: "Sample Interview 3",
          slug: { _type: "slug", current: "sample-interview-3" },
          excerpt: "This is the third sample interview for testing pagination.",
          publishedAt: new Date(Date.now() - 172800000).toISOString(),
          cardVariant: "full-image",
          youtubeUrl: "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
          thumbnail: undefined,
          guest: {
            name: "Guest Three",
            bio: undefined,
            image: undefined,
          },
        },
        {
          _id: "fallback-4",
          title: "Sample Interview 4",
          slug: { _type: "slug", current: "sample-interview-4" },
          excerpt:
            "This is the fourth sample interview for testing pagination.",
          publishedAt: new Date(Date.now() - 259200000).toISOString(),
          cardVariant: "full-image",
          youtubeUrl: "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
          thumbnail: undefined,
          guest: {
            name: "Guest Four",
            bio: undefined,
            image: undefined,
          },
        },
        {
          _id: "fallback-5",
          title: "Sample Interview 5",
          slug: { _type: "slug", current: "sample-interview-5" },
          excerpt: "This is the fifth sample interview for testing pagination.",
          publishedAt: new Date(Date.now() - 345600000).toISOString(),
          cardVariant: "full-image",
          youtubeUrl: "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
          thumbnail: undefined,
          guest: {
            name: "Guest Five",
            bio: undefined,
            image: undefined,
          },
        },
      ];

      totalInterviews = fallbackInterviews.length;
      // Slice the fallback data for current page
      const startIndex = (currentPage - 1) * postsPerPage;
      const endIndex = startIndex + postsPerPage;
      interviews = fallbackInterviews.slice(startIndex, endIndex);
    }
  } else {
    console.warn("Sanity not configured, showing placeholder content");
    // For fallback, we'll show 5 interviews for testing pagination
    totalInterviews = 5;
  }
} catch (e) {
  console.error("Error fetching interviews:", e);
  error = "Unable to load interviews";
  // Use fallback data when there's an error
  totalInterviews = 5;
}

const totalPages = Math.ceil(totalInterviews / postsPerPage);
---

<Layout>
  <div class="interview__feed--wrapper">
    <InterviewFeed
      interviews={interviews}
      currentPage={currentPage}
      postsPerPage={postsPerPage}
      error={error}
    />
  </div>

  <style>
    .interview__feed--wrapper {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem 1rem;
      flex-direction: column;
      justify-self: center;
    }
  </style>
</Layout>
