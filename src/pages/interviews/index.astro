---
import Layout from "../../layouts/Layout.astro";
import InterviewCard from "../../components/InterviewCard.astro";
import { client, queries } from "../../lib/sanity";
import type { InterviewPreview } from "../../types/sanity";

// Fetch interviews from Sanity with fallback
let interviews: InterviewPreview[] = [];
let error: string | null = null;

try {
  if (import.meta.env.PUBLIC_SANITY_PROJECT_ID) {
    interviews = await client.fetch<InterviewPreview[]>(queries.allInterviews);
  } else {
    console.warn("Sanity not configured, showing placeholder content");
  }
} catch (e) {
  console.error("Error fetching interviews:", e);
  error = "Unable to load interviews";
}

// Fallback data if no Sanity data available
const fallbackInterviews: InterviewPreview[] = [
  {
    _id: "fallback-1",
    title: "Sample Interview",
    slug: { _type: "slug", current: "sample-interview" },
    excerpt:
      "This is a sample interview. Connect Sanity to see your actual content.",
    publishedAt: new Date().toISOString(),
    cardVariant: "full-image",
    youtubeUrl: "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
    thumbnail: undefined,
    guest: {
      name: "Guest Name",
      bio: undefined,
      image: undefined,
    },
  },
];

const interviewsToShow =
  interviews.length > 0 ? interviews : fallbackInterviews;
---

<Layout>
  <div class="interview-feed">
    <header class="interview-feed__header">
      <h1>Interviews</h1>
      <p>Conversations with inspiring people</p>
    </header>

    {
      error && (
        <div class="error-message">
          <p>{error}</p>
          <p>Please check your Sanity configuration.</p>
        </div>
      )
    }

    {
      !import.meta.env.PUBLIC_SANITY_PROJECT_ID && (
        <div class="setup-notice">
          <h2>Sanity Setup Required</h2>
          <p>To see your interviews, please:</p>
          <ol>
            <li>
              Create a Sanity project at{" "}
              <a href="https://sanity.io" target="_blank">
                sanity.io
              </a>
            </li>
            <li>
              Add your project ID to <code>PUBLIC_SANITY_PROJECT_ID</code> in
              your environment variables
            </li>
            <li>Create interview documents in your Sanity studio</li>
          </ol>
        </div>
      )
    }

    <div class="interview-feed__cards">
      {
        interviewsToShow.map((interview) => (
          <InterviewCard
            title={interview.title}
            excerpt={interview.excerpt}
            publishedAt={interview.publishedAt}
            slug={interview.slug.current}
            youtubeUrl={interview.youtubeUrl}
            thumbnail={interview.thumbnail}
            guest={interview.guest}
            variant={interview.cardVariant || "full-image"}
            size="md"
          />
        ))
      }
    </div>

    {
      interviewsToShow.length === 0 && !error && (
        <div class="empty-state">
          <h2>No interviews yet</h2>
          <p>Check back soon for new conversations!</p>
        </div>
      )
    }
  </div>
</Layout>

<style>
  .interview-feed {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  .interview-feed__header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .interview-feed__header h1 {
    font-family: var(--font-header-primary);
    font-size: 1.25rem;
    color: #333;
    margin-bottom: 1.5rem;
  }

  .interview-feed__header p {
    font-family: var(--font-body);
    font-size: 1.1rem;
    color: #666;
  }

  .interview-feed__cards {
    margin: 0 auto;
    max-width: 600px;
    padding: 0 1rem;
  }

  .error-message,
  .setup-notice,
  .empty-state {
    background: #f8f0e5;
    padding: 2rem;
    border-radius: 8px;
    margin-bottom: 2rem;
    text-align: center;
  }

  .error-message {
    border-left: 4px solid #e74c3c;
  }

  .setup-notice {
    border-left: 4px solid #f39c12;
    text-align: left;
  }

  .setup-notice h2 {
    margin-top: 0;
    color: #f39c12;
  }

  .setup-notice ol {
    margin: 1rem 0;
  }

  .setup-notice code {
    background: #fff;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-family: monospace;
  }

  .empty-state {
    border-left: 4px solid #3498db;
  }

  @media (max-width: 768px) {
    .interview-feed {
      padding: 1rem 0.5rem;
    }

    .interview-feed__cards {
      margin: 0 0.5rem;
    }
  }
</style>
