---
import Layout from "../layouts/Layout.astro";
import BlogFeedCard from "../components/BlogFeedCard.astro";
import InterviewCard from "../components/InterviewCard.astro";
import { client, queries } from "../lib/sanity";
import type { BlogPostPreview, InterviewPreview } from "../types/sanity";

// Fetch latest content from Sanity
let latestInterview: InterviewPreview | null = null;
let latestBlogPosts: BlogPostPreview[] = [];

try {
  if (import.meta.env.PUBLIC_SANITY_PROJECT_ID) {
    // Fetch latest interview
    const interviews = await client.fetch<InterviewPreview[]>(
      queries.allInterviews
    );
    latestInterview = interviews[0] || null;

    // Fetch latest 2 blog posts
    const blogPosts = await client.fetch<BlogPostPreview[]>(
      queries.allBlogPosts
    );
    latestBlogPosts = blogPosts.slice(0, 2);
  }
} catch (error) {
  console.error("Error fetching content:", error);
}
---

<Layout>
  <!-- Homepage Structured Data -->
  <script
    type="application/ld+json"
    set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "WebPage",
      name: "The Twinkling Eye - Home",
      description:
        "Welcome to The Twinkling Eye - featuring the latest interviews and blog posts",
      url: "https://thetwinklingeye.com",
      mainEntity: {
        "@type": "ItemList",
        name: "Latest Content",
        itemListElement: [
          ...(latestInterview
            ? [
                {
                  "@type": "ListItem",
                  position: 1,
                  item: {
                    "@type": "VideoObject",
                    name: latestInterview.title,
                    description:
                      latestInterview.excerpt ||
                      `Interview with ${latestInterview.guest.name}`,
                    url: `https://thetwinklingeye.com/interviews/${latestInterview.slug.current}`,
                  },
                },
              ]
            : []),
          ...latestBlogPosts.map((post, index) => ({
            "@type": "ListItem",
            position: (latestInterview ? 2 : 1) + index,
            item: {
              "@type": "BlogPosting",
              headline: post.title,
              description: post.excerpt || post.title,
              url: `https://thetwinklingeye.com/blog/${post.slug.current}`,
              datePublished: post.publishedAt,
              author: {
                "@type": "Person",
                name: post.author?.name || "The Twinkling Eye",
              },
            },
          })),
        ],
      },
      breadcrumb: {
        "@type": "BreadcrumbList",
        itemListElement: [
          {
            "@type": "ListItem",
            position: 1,
            name: "Home",
            item: "https://thetwinklingeye.com",
          },
        ],
      },
    })}
  />
  <div class="home">
    <header class="home__header">
      <h1 class="home__headline">Welcome to The Twinkling Eye</h1>
    </header>

    <div class="home__content">
      <!-- Desktop Section Titles -->
      <div class="home__section-titles home__section-titles--desktop">
        <h2 class="home__section-title">Latest Interview</h2>
        <h2 class="home__section-title">Latest Blog Posts</h2>
        <h2 class="home__section-title home__section-title--hidden">
          Latest Blog Posts
        </h2>
      </div>

      <div class="home__grid">
        <!-- Latest Interview -->
        <div class="home__item">
          <h2 class="home__section-title home__section-title--mobile">
            Latest Interview
          </h2>
          {
            latestInterview ? (
              <InterviewCard
                title={latestInterview.title}
                excerpt={latestInterview.excerpt}
                publishedAt={latestInterview.publishedAt}
                slug={latestInterview.slug.current}
                youtubeUrl={latestInterview.youtubeUrl}
                thumbnail={latestInterview.thumbnail}
                guest={latestInterview.guest}
                variant="full-image"
                size="sm"
              />
            ) : (
              <div class="placeholder-card">
                <p>No interviews available yet</p>
              </div>
            )
          }
        </div>

        <!-- Latest Blog Posts -->
        {
          latestBlogPosts.map((post, index) => (
            <div class="home__item">
              {index === 0 && (
                <h2 class="home__section-title home__section-title--mobile">
                  Latest Blog Posts
                </h2>
              )}
              <BlogFeedCard
                title={post.title}
                excerpt={post.excerpt || ""}
                publishedAt={post.publishedAt}
                slug={post.slug.current}
                featuredImage={post.featuredImage}
                author={post.author}
                categories={post.categories || []}
                variant={post.cardVariant || "editorial"}
                size="sm"
              />
            </div>
          ))
        }

        {/* Show placeholders if we don't have enough blog posts */}
        {
          Array.from({ length: Math.max(0, 2 - latestBlogPosts.length) }).map(
            (_, index) => (
              <div class="home__item">
                {index === 0 && latestBlogPosts.length === 0 && (
                  <h2 class="home__section-title home__section-title--mobile">
                    Latest Blog Posts
                  </h2>
                )}
                <div class="placeholder-card">
                  <p>No blog posts available yet</p>
                </div>
              </div>
            )
          )
        }
      </div>
    </div>
  </div>
</Layout>

<style>
  .home {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
    min-height: 70vh;
  }

  .home__header {
    text-align: center;
    margin-bottom: 4rem;
  }

  .home__headline {
    font-family: var(--font-callout);
    font-size: var(--font-size-callout);
    font-weight: var(--font-weight-callout);
    line-height: 1.1;
    color: #461121;
    margin: 0;
  }

  .home__content {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .home__section-titles--desktop {
    display: flex;
    gap: 1rem;
  }

  .home__section-title {
    flex: 1;
    font-family: var(--font-header-primary);
    font-size: 1.25rem;
    color: #333;
    margin: 0;
    text-align: center;
  }

  .home__section-title--hidden {
    visibility: hidden;
  }

  .home__section-title--mobile {
    display: none;
    margin-bottom: 1rem;
  }

  .home__grid {
    display: flex;
    gap: 1rem;
    align-items: stretch;
  }

  .home__item {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 400px;
  }

  .home__item .blog__feed--card,
  .home__item .interview-card {
    width: 100%;
    max-width: none;
    height: 100%;
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .home__item .blog__feed--card__container,
  .home__item .interview-card .interview-card__full-image {
    flex: 1;
  }

  .home__column {
    display: flex;
    flex-direction: column;
  }

  .home__section-title {
    font-family: var(--font-header-primary);
    font-size: 1.25rem;
    color: #333;
    margin-bottom: 1.5rem;
    text-align: center;
  }

  /* Placeholder Card */
  .placeholder-card {
    border: 2px dashed #ccc;
    padding: 2rem;
    text-align: center;
    color: #666;
    font-style: italic;
  }

  /* Tablet Responsive */
  @media (max-width: 1024px) {
    .home__grid {
      flex-direction: column;
      gap: 2rem;
      align-items: center;
    }

    .home__section-titles--desktop {
      display: none;
    }

    .home__section-title--mobile {
      display: block;
    }

    .home__item {
      min-height: auto;
    }
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .home {
      padding: 1rem 0.5rem;
    }

    .home__header {
      margin-bottom: 2rem;
    }

    .home__headline {
      font-size: 2rem;
    }

    .home__grid {
      flex-direction: column;
      gap: 1.5rem;
    }

    .home__section-titles--desktop {
      display: none;
    }

    .home__section-title--mobile {
      display: block;
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }

    .home__item {
      min-height: auto;
    }
  }
</style>
