---
import Layout from "../layouts/Layout.astro";
import Card from "../components/Card.astro";
import NewsSidebar from "../components/NewsSidebar.astro";
import { client, queries } from "../lib/sanity";
import type { BlogPostPreview, InterviewPreview } from "../types/sanity";

// Fetch latest content from Sanity
let latestInterview: InterviewPreview | null = null;
let latestBlogPosts: BlogPostPreview[] = [];

try {
  if (import.meta.env.PUBLIC_SANITY_PROJECT_ID) {
    // Fetch latest interview
    const interviews = await client.fetch<InterviewPreview[]>(
      queries.allInterviews
    );
    latestInterview = interviews[0] || null;

    // Fetch latest 4 blog posts
    const blogPosts = await client.fetch<BlogPostPreview[]>(
      queries.allBlogPosts
    );
    latestBlogPosts = blogPosts.slice(0, 4);
  }
} catch (error) {
  console.error("Error fetching content:", error);
}
---

<Layout>
  <!-- Homepage Structured Data -->
  <script
    type="application/ld+json"
    set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "WebPage",
      name: "The Twinkling Eye - Home",
      description:
        "Welcome to The Twinkling Eye - featuring the latest interviews and blog posts",
      url: "https://thetwinklingeye.com",
      mainEntity: {
        "@type": "ItemList",
        name: "Latest Content",
        itemListElement: [
          ...(latestInterview
            ? [
                {
                  "@type": "ListItem",
                  position: 1,
                  item: {
                    "@type": "VideoObject",
                    name: latestInterview.title,
                    description:
                      latestInterview.excerpt ||
                      `Interview with ${latestInterview.guest.name}`,
                    url: `https://thetwinklingeye.com/interviews/${latestInterview.slug.current}`,
                  },
                },
              ]
            : []),
          ...latestBlogPosts.map((post, index) => ({
            "@type": "ListItem",
            position: (latestInterview ? 2 : 1) + index,
            item: {
              "@type": "BlogPosting",
              headline: post.title,
              description: post.excerpt || post.title,
              url: `https://thetwinklingeye.com/deep-dives/${post.slug.current}`,
              datePublished: post.publishedAt,
              author: {
                "@type": "Person",
                name: post.author?.name || "The Twinkling Eye",
              },
            },
          })),
        ],
      },
      breadcrumb: {
        "@type": "BreadcrumbList",
        itemListElement: [
          {
            "@type": "ListItem",
            position: 1,
            name: "Home",
            item: "https://thetwinklingeye.com",
          },
        ],
      },
    })}
  />
  <div class="home">
    <header class="home__header">
      <h1 class="home__headline">Welcome to The Twinkling Eye</h1>
    </header>

    <div class="home__layout">
      <!-- Column 1: Sidebar (Desktop only) -->
      <div class="home__sidebar-desktop">
        <NewsSidebar />
      </div>

      <!-- Cards Grid Container -->
      <div class="home__cards-container">
        <div
          class="home__section-title-with-link home__section-title-with-link--desktop"
        >
          <h2 class="home__section-title">Try these!</h2>
          <a href="/categories" class="categories-link">Browse Categories</a>
        </div>

        <h2 class="home__section-title home__section-title--mobile">
          Give these posts a try!
        </h2>

        <div class="home__cards-grid">
          {
            latestBlogPosts.slice(0, 4).map((post, index) =>
              post ? (
                <div class="home__card-item">
                  <Card
                    type="blog"
                    title={post.title}
                    excerpt={post.excerpt || ""}
                    publishedAt={post.publishedAt}
                    slug={post.slug.current}
                    featuredImage={post.featuredImage}
                    author={post.author}
                    categories={post.categories || []}
                    variant={post.cardVariant || "editorial"}
                    homepage={true}
                  />
                </div>
              ) : (
                <div class="home__card-item">
                  <div class="placeholder-card">
                    <p>No blog post available</p>
                  </div>
                </div>
              )
            )
          }

          {/* Fill remaining slots if we have fewer than 4 posts */}
          {
            Array.from({ length: Math.max(0, 4 - latestBlogPosts.length) }).map(
              (_, index) => (
                <div class="home__card-item">
                  <div class="placeholder-card">
                    <p>No blog post available</p>
                  </div>
                </div>
              )
            )
          }
        </div>
      </div>

      <!-- Sidebar for Mobile/Tablet (appears after posts) -->
      <div class="home__sidebar-mobile">
        <NewsSidebar variant="mobile" />
      </div>
    </div>
  </div>
</Layout>

<style>
  .home {
    padding: 2rem 1rem;
  }

  .home__header {
    text-align: center;
    margin-bottom: 4rem;
  }

  .home__headline {
    font-family: var(--font-callout);
    font-size: var(--font-size-callout);
    font-weight: var(--font-weight-callout);
    line-height: 1.1;
    color: #461121;
    margin: 0;
  }

  /* New layout with sidebar */
  .home__layout {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 2rem;
    align-items: start;
    max-width: 1200px;
    margin: 0;
  }

  /* Show desktop sidebar, hide mobile sidebar on desktop */
  .home__sidebar-desktop {
    display: block;
  }

  .home__sidebar-mobile {
    display: none;
  }

  /* Cards container and grid */
  .home__cards-container {
    display: flex;
    flex-direction: column;
  }

  .home__cards-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: min-content min-content;
  }

  .home__card-item {
    display: flex;
    flex-direction: column;
    height: 100%;
    max-width: 500px;
  }

  .home__card-item > :global(*) {
    flex: 1;
  }

  .home__section-title-with-link--desktop {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }

  .home__section-titles--desktop {
    display: flex;
    gap: 1rem;
  }

  .home__section-title {
    flex: 2;
    font-family: var(--font-header-primary);
    font-size: 1.25rem;
    color: #333;
    margin: 0;
    text-align: center;
    padding-left: 0;
  }

  .home__section-title--hidden {
    visibility: hidden;
  }

  .home__section-title--mobile {
    display: none;
    margin-bottom: 1rem;
  }

  .home__section-title-with-link {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }

  .home__section-title-with-link--mobile {
    display: none;
    margin-bottom: 1rem;
    text-align: center;
  }

  .categories-link {
    font-family: var(--font-body);
    font-size: 0.9rem;
    color: #461121;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s ease;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
  }

  .categories-link:hover {
    color: #2d0a14;
    background-color: rgba(163, 115, 81, 0.1);
    transform: translateY(-1px);
  }

  .home__grid {
    display: contents;
  }

  .home__item {
    display: flex;
    flex-direction: column;
  }

  .home__column {
    display: flex;
    flex-direction: column;
  }

  .home__section-title {
    font-family: var(--font-header-primary);
    font-size: 1.25rem;
    color: #333;
    margin-bottom: 1.5rem;
    text-align: center;
  }

  /* Placeholder Card */
  .placeholder-card {
    border: 2px dashed #ccc;
    padding: 2rem;
    text-align: center;
    color: #666;
    font-style: italic;
  }

  /* Tablet and Mobile Responsive */
  @media (max-width: 1024px) {
    .home__layout {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    /* Hide desktop sidebar, show mobile sidebar */
    .home__sidebar-desktop {
      display: none;
    }

    .home__sidebar-mobile {
      display: block;
      display: flex;
      justify-content: center;
      width: 100%;
    }

    .home__sidebar-mobile .news-sidebar {
      max-width: 600px;
      width: 100%;
    }

    /* Center cards container on mobile */
    .home__cards-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }

    /* Mobile cards grid - single column */
    .home__cards-grid {
      grid-template-columns: 1fr;
      grid-template-rows: auto;
      gap: 1.5rem;
      max-width: 600px;
      width: 100%;
    }

    .home__section-title-with-link--desktop {
      display: none;
    }

    .home__section-title--mobile {
      display: block;
    }

    .home__section-title-with-link--mobile {
      display: block;
      margin-bottom: 1rem;
    }

    .home__item {
      width: 100%;
      max-width: none;
    }
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .home {
      padding: 1rem 0.5rem;
    }

    .home__header {
      margin-bottom: 2rem;
    }

    .home__headline {
      font-size: 2rem;
    }

    .home__layout {
      gap: 1.5rem;
    }

    .home__section-title-with-link--desktop {
      display: none;
    }

    .home__section-title--mobile {
      display: block;
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }

    .home__section-title-with-link--mobile {
      display: block;
    }

    .home__item {
      width: 100%;
      max-width: none;
    }
  }
</style>
