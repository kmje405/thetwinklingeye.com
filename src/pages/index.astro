---
import Layout from "../layouts/Layout.astro";
import Card from "../components/Card.astro";
import NewsSidebar from "../components/NewsSidebar.astro";
import { client, queries } from "../lib/sanity";
import type { BlogPostPreview, InterviewPreview } from "../types/sanity";

// Fetch latest content from Sanity
let latestInterview: InterviewPreview | null = null;
let latestBlogPosts: BlogPostPreview[] = [];

try {
  if (import.meta.env.PUBLIC_SANITY_PROJECT_ID) {
    // Fetch latest interview
    const interviews = await client.fetch<InterviewPreview[]>(
      queries.allInterviews
    );
    latestInterview = interviews[0] || null;

    // Fetch latest 2 blog posts
    const blogPosts = await client.fetch<BlogPostPreview[]>(
      queries.allBlogPosts
    );
    latestBlogPosts = blogPosts.slice(0, 2);
  }
} catch (error) {
  console.error("Error fetching content:", error);
}
---

<Layout>
  <!-- Homepage Structured Data -->
  <script
    type="application/ld+json"
    set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "WebPage",
      name: "The Twinkling Eye - Home",
      description:
        "Welcome to The Twinkling Eye - featuring the latest interviews and blog posts",
      url: "https://thetwinklingeye.com",
      mainEntity: {
        "@type": "ItemList",
        name: "Latest Content",
        itemListElement: [
          ...(latestInterview
            ? [
                {
                  "@type": "ListItem",
                  position: 1,
                  item: {
                    "@type": "VideoObject",
                    name: latestInterview.title,
                    description:
                      latestInterview.excerpt ||
                      `Interview with ${latestInterview.guest.name}`,
                    url: `https://thetwinklingeye.com/interviews/${latestInterview.slug.current}`,
                  },
                },
              ]
            : []),
          ...latestBlogPosts.map((post, index) => ({
            "@type": "ListItem",
            position: (latestInterview ? 2 : 1) + index,
            item: {
              "@type": "BlogPosting",
              headline: post.title,
              description: post.excerpt || post.title,
              url: `https://thetwinklingeye.com/deep-dives/${post.slug.current}`,
              datePublished: post.publishedAt,
              author: {
                "@type": "Person",
                name: post.author?.name || "The Twinkling Eye",
              },
            },
          })),
        ],
      },
      breadcrumb: {
        "@type": "BreadcrumbList",
        itemListElement: [
          {
            "@type": "ListItem",
            position: 1,
            name: "Home",
            item: "https://thetwinklingeye.com",
          },
        ],
      },
    })}
  />
  <div class="home">
    <header class="home__header">
      <h1 class="home__headline">Welcome to The Twinkling Eye</h1>
    </header>

    <div class="home__layout">
      <!-- Column 1: Sidebar -->
      <NewsSidebar />

      <!-- Column 2: Latest Deep Dives Section + First Post -->
      <div class="home__column-2">
        <div
          class="home__section-title-with-link home__section-title-with-link--desktop"
        >
          <h2 class="home__section-title">Latest Deep Dives</h2>
          <a href="/categories" class="categories-link">Browse Categories</a>
        </div>

        {
          latestBlogPosts[0] ? (
            <div class="home__item">
              <h2 class="home__section-title home__section-title--mobile">
                Latest Deep Dives
              </h2>
              <div class="home__section-title-with-link home__section-title-with-link--mobile">
                <a href="/categories" class="categories-link">
                  Browse Categories
                </a>
              </div>
              <Card
                type="blog"
                title={latestBlogPosts[0].title}
                excerpt={latestBlogPosts[0].excerpt || ""}
                publishedAt={latestBlogPosts[0].publishedAt}
                slug={latestBlogPosts[0].slug.current}
                featuredImage={latestBlogPosts[0].featuredImage}
                author={latestBlogPosts[0].author}
                categories={latestBlogPosts[0].categories || []}
                variant={latestBlogPosts[0].cardVariant || "editorial"}
                homepage={true}
              />
            </div>
          ) : (
            <div class="home__item">
              <h2 class="home__section-title home__section-title--mobile">
                Latest Deep Dives
              </h2>
              <div class="home__section-title-with-link home__section-title-with-link--mobile">
                <a href="/categories" class="categories-link">
                  Browse Categories
                </a>
              </div>
              <div class="placeholder-card">
                <p>No blog posts available yet</p>
              </div>
            </div>
          )
        }
      </div>

      <!-- Column 3: Second Post -->
      <div class="home__column-3">
        {
          latestBlogPosts[1] ? (
            <div class="home__item">
              <Card
                type="blog"
                title={latestBlogPosts[1].title}
                excerpt={latestBlogPosts[1].excerpt || ""}
                publishedAt={latestBlogPosts[1].publishedAt}
                slug={latestBlogPosts[1].slug.current}
                featuredImage={latestBlogPosts[1].featuredImage}
                author={latestBlogPosts[1].author}
                categories={latestBlogPosts[1].categories || []}
                variant={latestBlogPosts[1].cardVariant || "editorial"}
                homepage={true}
              />
            </div>
          ) : (
            <div class="home__item">
              <div class="placeholder-card">
                <p>No blog posts available yet</p>
              </div>
            </div>
          )
        }
      </div>
    </div>
  </div>
</Layout>

<style>
  .home {
    padding: 2rem 1rem;
  }

  .home__header {
    text-align: center;
    margin-bottom: 4rem;
  }

  .home__headline {
    font-family: var(--font-callout);
    font-size: var(--font-size-callout);
    font-weight: var(--font-weight-callout);
    line-height: 1.1;
    color: #461121;
    margin: 0;
  }

  /* New layout with sidebar */
  .home__layout {
    display: grid;
    grid-template-columns: 300px 1fr 1fr;
    gap: 2rem;
    align-items: start;
    max-width: 1200px;
    margin: 0 auto;
  }

  .home__column-2,
  .home__column-3 {
    display: flex;
    flex-direction: column;
  }

  .home__column-3 {
    margin-top: 6.7rem;
  }

  .home__section-title-with-link--desktop {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
  }

  .home__section-titles--desktop {
    display: flex;
    gap: 1rem;
  }

  .home__section-title {
    flex: 2;
    font-family: var(--font-header-primary);
    font-size: 1.25rem;
    color: #333;
    margin: 0;
    text-align: center;
    padding-left: 0;
  }

  .home__section-title--hidden {
    visibility: hidden;
  }

  .home__section-title--mobile {
    display: none;
    margin-bottom: 1rem;
  }

  .home__section-title-with-link {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }

  .home__section-title-with-link--mobile {
    display: none;
    margin-bottom: 1rem;
    text-align: center;
  }

  .categories-link {
    font-family: var(--font-body);
    font-size: 0.9rem;
    color: #a37351;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s ease;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
  }

  .categories-link:hover {
    color: #461121;
    background-color: rgba(163, 115, 81, 0.1);
    transform: translateY(-1px);
  }

  .home__grid {
    display: contents;
  }

  .home__item {
    display: flex;
    flex-direction: column;
  }

  .home__column {
    display: flex;
    flex-direction: column;
  }

  .home__section-title {
    font-family: var(--font-header-primary);
    font-size: 1.25rem;
    color: #333;
    margin-bottom: 1.5rem;
    text-align: center;
  }

  /* Placeholder Card */
  .placeholder-card {
    border: 2px dashed #ccc;
    padding: 2rem;
    text-align: center;
    color: #666;
    font-style: italic;
  }

  /* Tablet and Mobile Responsive */
  @media (max-width: 1024px) {
    .home__layout {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .home__column-2,
    .home__column-3 {
      width: 100%;
    }

    .home__column-3 {
      margin-top: 0;
    }

    .home__section-title-with-link--desktop {
      display: none;
    }

    .home__section-title--mobile {
      display: block;
    }

    .home__section-title-with-link--mobile {
      display: block;
      margin-bottom: 1rem;
    }

    .home__item {
      width: 100%;
      max-width: none;
    }
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .home {
      padding: 1rem 0.5rem;
    }

    .home__header {
      margin-bottom: 2rem;
    }

    .home__headline {
      font-size: 2rem;
    }

    .home__layout {
      gap: 1.5rem;
    }

    .home__section-title-with-link--desktop {
      display: none;
    }

    .home__section-title--mobile {
      display: block;
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }

    .home__section-title-with-link--mobile {
      display: block;
    }

    .home__item {
      width: 100%;
      max-width: none;
    }
  }
</style>
