---
import Card from "./Card.astro";
import { client, queries } from "../lib/sanity";
import type { InterviewPreview } from "../types/sanity";

interface Props {
  currentPage?: number;
  postsPerPage?: number;
  interviews: InterviewPreview[];
  error?: string | null;
}

const {
  currentPage = 1,
  postsPerPage = 2,
  interviews,
  error = null,
} = Astro.props;

// Fallback data if no Sanity data available
const fallbackInterviews: InterviewPreview[] = [
  {
    _id: "fallback-1",
    title: "Sample Interview 1",
    slug: { _type: "slug", current: "sample-interview-1" },
    excerpt:
      "This is the first sample interview. Connect Sanity to see your actual content.",
    publishedAt: new Date().toISOString(),
    cardVariant: "full-image",
    youtubeUrl: "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
    thumbnail: undefined,
    guest: {
      name: "Guest One",
      bio: undefined,
      image: undefined,
    },
  },
  {
    _id: "fallback-2",
    title: "Sample Interview 2",
    slug: { _type: "slug", current: "sample-interview-2" },
    excerpt: "This is the second sample interview for testing pagination.",
    publishedAt: new Date(Date.now() - 86400000).toISOString(), // 1 day ago
    cardVariant: "full-image",
    youtubeUrl: "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
    thumbnail: undefined,
    guest: {
      name: "Guest Two",
      bio: undefined,
      image: undefined,
    },
  },
  {
    _id: "fallback-3",
    title: "Sample Interview 3",
    slug: { _type: "slug", current: "sample-interview-3" },
    excerpt: "This is the third sample interview for testing pagination.",
    publishedAt: new Date(Date.now() - 172800000).toISOString(), // 2 days ago
    cardVariant: "full-image",
    youtubeUrl: "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
    thumbnail: undefined,
    guest: {
      name: "Guest Three",
      bio: undefined,
      image: undefined,
    },
  },
  {
    _id: "fallback-4",
    title: "Sample Interview 4",
    slug: { _type: "slug", current: "sample-interview-4" },
    excerpt: "This is the fourth sample interview for testing pagination.",
    publishedAt: new Date(Date.now() - 259200000).toISOString(), // 3 days ago
    cardVariant: "full-image",
    youtubeUrl: "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
    thumbnail: undefined,
    guest: {
      name: "Guest Four",
      bio: undefined,
      image: undefined,
    },
  },
  {
    _id: "fallback-5",
    title: "Sample Interview 5",
    slug: { _type: "slug", current: "sample-interview-5" },
    excerpt: "This is the fifth sample interview for testing pagination.",
    publishedAt: new Date(Date.now() - 345600000).toISOString(), // 4 days ago
    cardVariant: "full-image",
    youtubeUrl: "https://www.youtube.com/watch?v=dQw4w9WgXcQ",
    thumbnail: undefined,
    guest: {
      name: "Guest Five",
      bio: undefined,
      image: undefined,
    },
  },
];

// If we have real interviews, use them; otherwise use paginated fallback data
let interviewsToShow: InterviewPreview[];

if (interviews.length > 0) {
  interviewsToShow = interviews;
} else {
  // For fallback data, we need to manually paginate since we're not using Sanity
  const startIndex = (currentPage - 1) * postsPerPage;
  const endIndex = startIndex + postsPerPage;
  interviewsToShow = fallbackInterviews.slice(startIndex, endIndex);

  // Debug logging for fallback pagination
  console.log("Fallback pagination - currentPage:", currentPage);
  console.log("Fallback pagination - startIndex:", startIndex);
  console.log("Fallback pagination - endIndex:", endIndex);
  console.log(
    "Fallback pagination - sliced interviews:",
    interviewsToShow.length
  );
}
---

<div class="interview__feed">
  {
    error && (
      <div class="error-message">
        <p>{error}</p>
        <p>Please check your Sanity configuration.</p>
      </div>
    )
  }

  {
    !import.meta.env.PUBLIC_SANITY_PROJECT_ID && (
      <div class="setup-notice">
        <h2>Sanity Setup Required</h2>
        <p>To see your interviews, please:</p>
        <ol>
          <li>
            Create a Sanity project at{" "}
            <a href="https://sanity.io" target="_blank">
              sanity.io
            </a>
          </li>
          <li>
            Add your project ID to <code>PUBLIC_SANITY_PROJECT_ID</code> in your
            environment variables
          </li>
          <li>Create interview documents in your Sanity studio</li>
        </ol>
      </div>
    )
  }

  <div class="interview__feed-cards">
    {
      interviewsToShow.map((interview) => (
        <Card
          type="interview"
          title={interview.title}
          excerpt={interview.excerpt}
          publishedAt={interview.publishedAt}
          slug={interview.slug.current}
          youtubeUrl={interview.youtubeUrl}
          thumbnail={interview.thumbnail}
          guest={interview.guest}
        />
      ))
    }
  </div>

  {
    interviewsToShow.length === 0 && !error && (
      <div class="empty-state">
        <h2>No interviews yet</h2>
        <p>Check back soon for new conversations!</p>
      </div>
    )
  }
</div>

<style>
  .interview__feed {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin: 0 1rem;
    max-width: 800px;
    margin: 0 auto;
    overflow-x: hidden;
  }

  .interview__feed-cards {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    overflow-x: hidden;
  }

  .error-message,
  .setup-notice,
  .empty-state {
    background: #f8f0e5;
    padding: 2rem;
    border-radius: 8px;
    margin-bottom: 2rem;
    text-align: center;
    max-width: 100%;
    box-sizing: border-box;
  }

  .error-message {
    border-left: 4px solid #e74c3c;
  }

  .setup-notice {
    border-left: 4px solid #f39c12;
    text-align: left;
  }

  .setup-notice h2 {
    margin-top: 0;
    color: #f39c12;
  }

  .setup-notice ol {
    margin: 1rem 0;
  }

  .setup-notice code {
    background: #fff;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-family: monospace;
  }

  .empty-state {
    border-left: 4px solid #3498db;
  }

  @media (max-width: 768px) {
    .interview__feed {
      gap: 1rem;
      margin: 0 0.5rem;
    }
  }
</style>
