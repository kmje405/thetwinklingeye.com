---
import { Image } from "astro:assets";
import footerAccentIcon from "../assets/footerAccentIcon.png";
import ejcLogo from "../assets/ejcLogo.png";
import { getSiteConfig } from "../lib/siteConfig";
import { client } from "../lib/sanity";

// Check if there are any interviews
let hasInterviews = false;
try {
  if (import.meta.env.PUBLIC_SANITY_PROJECT_ID) {
    const interviews = await client.fetch(
      `*[_type == "interview"] | order(publishedAt desc) [0...1] { _id }`
    );
    hasInterviews = interviews.length > 0;
  }
} catch (error) {
  console.error("Error checking for interviews:", error);
  hasInterviews = false;
}

// Check if there are any poetry posts
let hasPoetry = false;
try {
  if (import.meta.env.PUBLIC_SANITY_PROJECT_ID) {
    const poetryCategory = await client.fetch(
      `*[_type == "category" && slug.current == "poetry"][0]{ _id }`
    );
    if (poetryCategory) {
      const poetryPosts = await client.fetch(
        `*[_type == "blogPost" && references($categoryId)] | order(publishedAt desc) [0...1] { _id }`,
        { categoryId: poetryCategory._id }
      );
      hasPoetry = poetryPosts.length > 0;
    }
  }
} catch (error) {
  console.error("Error checking for poetry posts:", error);
  hasPoetry = false;
}

// Check if there are any daily reflection posts
let hasDailyReflections = false;
try {
  if (import.meta.env.PUBLIC_SANITY_PROJECT_ID) {
    const dailyReflectionCategory = await client.fetch(
      `*[_type == "category" && slug.current == "daily-reflection"][0]{ _id }`
    );
    if (dailyReflectionCategory) {
      const dailyReflectionPosts = await client.fetch(
        `*[_type == "blogPost" && references($categoryId)] | order(publishedAt desc) [0...1] { _id }`,
        { categoryId: dailyReflectionCategory._id }
      );
      hasDailyReflections = dailyReflectionPosts.length > 0;
    }
  }
} catch (error) {
  console.error("Error checking for daily reflection posts:", error);
  hasDailyReflections = false;
}

// Check if there are any worldviews posts
let hasWorldviews = false;
try {
  if (import.meta.env.PUBLIC_SANITY_PROJECT_ID) {
    const worldviewsCategory = await client.fetch(
      `*[_type == "category" && slug.current == "worldviews"][0]{ _id }`
    );
    if (worldviewsCategory) {
      const worldviewsPosts = await client.fetch(
        `*[_type == "blogPost" && references($categoryId)] | order(publishedAt desc) [0...1] { _id }`,
        { categoryId: worldviewsCategory._id }
      );
      hasWorldviews = worldviewsPosts.length > 0;
    }
  }
} catch (error) {
  console.error("Error checking for worldviews posts:", error);
  hasWorldviews = false;
}

const navItems = [
  { name: "Home", href: "/" },
  { name: "Deep Dives", href: "/blog" },
  ...(hasPoetry ? [{ name: "Poetry", href: "/poetry" }] : []),
  ...(hasDailyReflections
    ? [{ name: "Daily Reflections", href: "/daily-reflections" }]
    : []),
  ...(hasWorldviews ? [{ name: "Worldviews", href: "/worldviews" }] : []),
  ...(hasInterviews ? [{ name: "Interviews", href: "/interviews" }] : []),
  { name: "About", href: "/about" },
  { name: "Contact", href: "/contact" },
];

// Get site configuration for social media links
const siteConfig = await getSiteConfig();
const socialMedia = siteConfig.socialMedia;

// Define social media platforms with their Font Awesome icons
const socialPlatforms = [
  {
    name: "Twitter",
    url: socialMedia?.twitter,
    icon: "fab fa-x-twitter", // X/Twitter icon
    label: "Follow us on X (Twitter)",
  },
  {
    name: "Instagram",
    url: socialMedia?.instagram,
    icon: "fab fa-instagram", // Instagram icon
    label: "Follow us on Instagram",
  },
  {
    name: "Facebook",
    url: socialMedia?.facebook,
    icon: "fab fa-facebook-f", // Facebook icon
    label: "Follow us on Facebook",
  },
  {
    name: "LinkedIn",
    url: socialMedia?.linkedin,
    icon: "fab fa-linkedin-in", // LinkedIn icon
    label: "Connect with us on LinkedIn",
  },
].filter((platform) => platform.url && platform.url.trim() !== "");

// Define RSS and sitemap links
const feedLinks = [
  {
    name: "RSS Feed",
    url: "/rss.xml",
    icon: "fas fa-rss", // RSS icon
    label: "Subscribe to our RSS feed",
  },
  {
    name: "Sitemap",
    url: "/sitemap",
    icon: "fas fa-sitemap", // Sitemap icon
    label: "View our sitemap",
  },
];
---

<footer class="footer">
  <div class="footer__content">
    <!-- Newsletter Section -->
    <div class="footer__newsletter">
      <h3 class="footer__title">Let's keep up!</h3>

      <!-- Newsletter Form -->
      <form id="footer-newsletter-form" class="newsletter-form">
        <!-- Honeypot field for spam protection -->
        <input
          type="text"
          name="hp"
          aria-label="Leave this field empty"
          style="position: absolute; left: -9999px; opacity: 0;"
          tabindex="-1"
          autocomplete="off"
        />

        <div class="form-group">
          <label for="footer-email" class="sr-only">Email Address</label>
          <input
            type="email"
            id="footer-email"
            name="email"
            placeholder="example@email.com"
            required
            class="email-input"
            aria-describedby="footer-message"
          />
        </div>

        <div class="form-group consent-group">
          <label class="consent-label">
            <input
              type="checkbox"
              id="footer-consent"
              name="consent"
              required
              class="consent-checkbox"
            />
            <span class="consent-text">
              Opt in to receive news and updates.
            </span>
          </label>
        </div>

        <div class="submit-container">
          <Image
            src={footerAccentIcon}
            alt="Footer accent icon"
            class="footer-accent-icon"
            width={80}
            height={80}
            format="webp"
            quality={85}
          />
          <button type="submit" class="submit-btn">SUBSCRIBE</button>
        </div>

        <div
          class="message"
          id="footer-message"
          style="display: none;"
          role="alert"
          aria-live="polite"
        >
        </div>
      </form>
    </div>

    <!-- Navigation Links -->
    <nav class="footer__nav">
      <ul class="footer__nav-list">
        {
          navItems.map((item) => (
            <li class="footer__nav-item">
              <a href={item.href} class="footer__nav-link">
                {item.name}
              </a>
            </li>
          ))
        }
      </ul>
    </nav>

    <!-- Social Media and Feed Links -->
    <div class="footer__links">
      <div class="all-links">
        {
          socialPlatforms.map((platform) => (
            <a
              href={platform.url}
              class="footer-link"
              target="_blank"
              rel="noopener noreferrer"
              aria-label={platform.label}
            >
              <i class={`link-icon ${platform.icon}`} />
              <span class="link-name">{platform.name}</span>
            </a>
          ))
        }
        {
          feedLinks.map((feed) => (
            <a href={feed.url} class="footer-link" aria-label={feed.label}>
              <i class={`link-icon ${feed.icon}`} />
              <span class="link-name">{feed.name}</span>
            </a>
          ))
        }
      </div>
    </div>
  </div>

  <!-- Developer Promo Banner -->
  <div class="footer__promo">
    <p>
      <Image
        src={ejcLogo}
        alt="EJC Logo"
        class="ejc-logo"
        width={40}
        height={40}
        format="webp"
        quality={85}
      />
      designed by
      <a
        rel="stylesheet"
        href="https://www.eastlandjones.com"
        class="promo-link"
      >
        eastland jones creative
      </a>
    </p>
  </div>
</footer>

<!-- Newsletter Script -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById(
      "footer-newsletter-form"
    ) as HTMLFormElement;
    if (!form) return;

    const emailInput = form.querySelector(
      'input[type="email"]'
    ) as HTMLInputElement;
    const consentInput = form.querySelector(
      'input[name="consent"]'
    ) as HTMLInputElement;
    const submitBtn = form.querySelector(
      'button[type="submit"]'
    ) as HTMLButtonElement;
    const messageDiv = form.querySelector(".message") as HTMLDivElement;

    if (!emailInput || !consentInput || !submitBtn || !messageDiv) return;

    form.addEventListener("submit", async function (e: Event) {
      e.preventDefault();

      const email = emailInput.value.trim();
      const consent = consentInput.checked;
      const honeypotInput = form.querySelector(
        'input[name="hp"]'
      ) as HTMLInputElement;
      const honeypot = honeypotInput?.value;

      // Check honeypot
      if (honeypot) return;

      // Basic validation
      if (!email) {
        showMessage("Please enter your email address.", "error");
        return;
      }

      if (!isValidEmail(email)) {
        showMessage("Please enter a valid email address.", "error");
        return;
      }

      if (!consent) {
        showMessage("Please agree to receive our newsletter.", "error");
        return;
      }

      // Set loading state
      submitBtn.disabled = true;
      submitBtn.textContent = "Subscribing...";

      try {
        const response = await fetch("/.netlify/functions/subscribe", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            email: email,
            consent: true,
          }),
        });

        const result = await response.json();

        if (response.ok) {
          showMessage("Successfully subscribed!", "success");
          form.reset();
        } else {
          showMessage(
            result.error || "Subscription failed. Please try again.",
            "error"
          );
        }
      } catch (error) {
        showMessage("Network error. Please try again later.", "error");
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "SUBSCRIBE";
      }
    });

    function showMessage(message: string, type: string): void {
      messageDiv.textContent = message;
      messageDiv.className = `message ${type}`;
      messageDiv.style.display = "block";

      // Focus the message for screen readers
      messageDiv.setAttribute("tabindex", "-1");
      messageDiv.focus();

      if (type === "success") {
        setTimeout(() => {
          messageDiv.style.display = "none";
          messageDiv.removeAttribute("tabindex");
        }, 5000);
      }
    }

    function isValidEmail(email: string): boolean {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }
  });
</script>

<style>
  /* Screen reader only class */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* Footer base styles */
  .footer {
    background-color: #461121;
    color: white;
    padding: 3rem 0 0 0;
  }

  .footer__content {
    max-width: 1200px;
    margin: 0 auto;
    padding-bottom: 2rem;
  }

  .footer__newsletter {
    text-align: center;
  }

  .footer__title {
    font-family: var(--font-callout);
    font-size: var(--font-size-callout);
    font-weight: var(--font-weight-callout);
    margin-bottom: 2rem;
    color: var(--color-cream-peach);
    text-transform: none;
  }

  /* Newsletter form styles */
  .newsletter-form {
    max-width: 500px;
    margin: 0 auto;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .email-input {
    background-color: #f8f0e5;
    color: var(--color-brown-warm);
    border: none;
    border-radius: 0;
    font-family: var(--font-body);
    font-size: var(--font-size-body);
    padding: 0.5rem;
    width: 100%;
    box-sizing: border-box;
    text-align: center;
    transition: all 0.3s ease;
  }

  .email-input::placeholder {
    color: #444;
  }

  .email-input:focus {
    outline: 2px solid #007acc;
    outline-offset: 2px;
    background: #f8f0e5;
  }

  /* Consent checkbox styling */
  .consent-group {
    display: flex;
    justify-content: center;
  }

  .consent-label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    font-family: var(--font-body);
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.9);
  }

  .consent-checkbox {
    position: absolute;
    opacity: 0;
    width: 1px;
    height: 1px;
    margin: 0;
    padding: 0;
    border: 0;
    clip: rect(0, 0, 0, 0);
  }

  .consent-checkbox:focus + .consent-text::before {
    outline: 2px solid #007acc;
    outline-offset: 2px;
  }

  .consent-text {
    position: relative;
    padding-left: 2rem;
  }

  .consent-text::before {
    content: "";
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 0;
    display: inline-block;
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    transition: all 0.3s ease;
    background-color: transparent;
  }

  .consent-checkbox:checked + .consent-text::before {
    background: white;
    border-color: white;
  }

  .consent-checkbox:checked + .consent-text::after {
    content: "âœ“";
    color: #461121;
    font-weight: bold;
    font-size: 14px;
    position: absolute;
    left: 6px;
    top: 50%;
    transform: translateY(-50%);
  }

  /* Submit button container and styling */
  .submit-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
  }

  .footer-accent-icon {
    width: 80px;
    height: auto;
    color: white;
    transform: translateX(-20px);
    object-fit: contain;
  }

  .submit-btn {
    padding: 1rem 2rem;
    background: var(--color-green-sage);
    color: white;
    border: none;
    border-radius: 0;
    font-family: var(--font-body);
    font-size: var(--font-size-body);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    transform: translateX(-20px);
    height: auto;
    box-sizing: border-box;
  }

  .submit-btn:hover {
    background: var(--color-green-olive);
    transform: translateY(-2px) translateX(-20px);
  }

  .submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .submit-btn:focus {
    outline: 2px solid #007acc;
    outline-offset: 2px;
  }

  /* Message styling */
  .message {
    margin-top: 1rem;
    padding: 0.75rem;
    border-radius: 4px;
    font-family: var(--font-body);
    font-size: 0.9rem;
    text-align: center;
  }

  .message.success {
    background-color: rgba(76, 175, 80, 0.1);
    color: #4caf50;
    border: 1px solid rgba(76, 175, 80, 0.3);
  }

  .message.error {
    background-color: rgba(244, 67, 54, 0.1);
    color: #f44336;
    border: 1px solid rgba(244, 67, 54, 0.3);
  }

  .footer__nav {
    padding-top: 2rem;
  }

  .footer__nav-list {
    display: flex;
    justify-content: center;
    gap: 2rem;
    list-style: none;
    margin: 0;
    padding: 0;
    flex-wrap: wrap;
  }

  .footer__nav-link {
    color: var(--color-cream-peach);
    text-decoration: none;
    font-size: 1.1rem;
    font-weight: 500;
    padding: 0.5rem 1rem;
    border-radius: 0;
    transition: all 0.3s ease;
    text-transform: uppercase;
  }

  .footer__nav-link:hover {
    color: white;
    background-color: rgba(255, 255, 255, 0.1);
  }

  .footer__nav-link:focus {
    outline: 2px solid #007acc;
    outline-offset: 2px;
  }

  .footer__links {
    padding-top: 2rem;
    text-align: center;
  }

  .all-links {
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    flex-wrap: wrap;
  }

  .footer-link {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    color: var(--color-cream-peach);
    text-decoration: none;
    padding: 1rem;
    transition: all 0.3s ease;
    min-width: 80px;
  }

  .footer-link:hover {
    color: white;
    background-color: rgba(255, 255, 255, 0.1);
    transform: translateY(-2px);
  }

  .footer-link:focus {
    outline: 2px solid #007acc;
    outline-offset: 2px;
  }

  .link-icon {
    font-size: 1.5rem;
    display: block;
  }

  .link-name {
    font-size: 0.9rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .footer__promo {
    display: flex;
    background: #3d2b1e;
    padding: 0;
    min-height: 60px;
    text-align: center;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.7);
  }

  .footer__promo p {
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .ejc-logo {
    width: 40px;
    height: 40px;
    margin-right: 0.5rem;
    vertical-align: middle;
  }

  .promo-link {
    color: white;
    text-decoration: underline;
    font-weight: 500;
  }

  .promo-link:hover {
    text-decoration: underline;
  }

  .promo-link:focus {
    outline: 2px solid #007acc;
    outline-offset: 2px;
  }

  /* Mobile Responsive Styles */
  @media (max-width: 768px) {
    .footer__content {
      padding: 0 1rem 2rem 1rem;
    }

    .footer__title {
      font-size: 1.5rem;
    }

    /* Newsletter form mobile styles */
    .newsletter-form {
      max-width: 100%;
    }

    .consent-label {
      font-size: 0.8rem;
      text-align: center;
      flex-direction: column;
      gap: 0.5rem;
    }

    .submit-btn {
      width: 100%;
      max-width: 200px;
      transform: none;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
    }

    .footer-accent-icon {
      transform: none;
    }

    /* Footer navigation mobile styles */
    .footer__nav-list {
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }

    /* Social media mobile styles */
    .social-links {
      gap: 1rem;
    }

    .social-link {
      min-width: 60px;
      padding: 0.75rem;
    }

    .social-icon {
      font-size: 1.25rem;
    }

    .social-name {
      font-size: 0.8rem;
    }

    /* Feed links mobile styles */
    .feed-links {
      gap: 1rem;
    }

    .feed-link {
      min-width: 60px;
      padding: 0.75rem;
    }

    .feed-icon {
      font-size: 1.25rem;
    }

    .feed-name {
      font-size: 0.8rem;
    }
  }
</style>
